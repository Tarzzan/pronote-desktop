name: Build & Release Pronote Desktop

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

jobs:
  # ─── Job : Lint & Tests ────────────────────────────────────────────────────
  lint:
    name: Lint, Type Check & Backend Contracts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm exec tsc -b --noEmit

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install minimal backend dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install flask

      - name: Backend contract tests
        run: python -m unittest discover -s tests -p 'test_backend_contract.py'

  # ─── Job : Build Linux (.deb) ──────────────────────────────────────────────
  build-linux:
    name: Build Linux (.deb)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y fakeroot dpkg-dev rpm libgtk-3-0 libnotify4 libnss3 libxss1 libxtst6

      - name: Install project dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web assets
        run: pnpm build:web

      - name: Build .deb package
        run: pnpm exec electron-builder --linux deb --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: pronote-desktop-linux-deb
          path: release/*.deb
          retention-days: 30

  # ─── Job : Release (uniquement sur les tags v*) ────────────────────────────
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-linux
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: pronote-desktop-linux-deb
          path: release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*.deb
          generate_release_notes: true
          body: |
            ## Pronote Desktop ${{ github.ref_name }}

            ### Installation Ubuntu/Debian

            ```bash
            sudo dpkg -i pronote-desktop_*_amd64.deb
            sudo apt-get install -f
            ```

            ### Changements
            Voir les commits ci-dessous pour le détail des changements.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
